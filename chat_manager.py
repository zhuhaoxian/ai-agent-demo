"""
å¯¹è¯ç®¡ç†æ¨¡å—
ç®¡ç†å¯¹è¯åŽ†å²å’Œä¸Šä¸‹æ–‡
"""
from typing import List, Dict, Any

from config import MAX_CHAT_HISTORY_LENGTH


class ChatManager:
    """å¯¹è¯åŽ†å²ç®¡ç†å™¨"""

    # ç³»ç»Ÿæç¤ºï¼šæŒ‡å¯¼ AI å¦‚ä½•å¤„ç†å®¡æ‰¹æµç¨‹
    SYSTEM_PROMPT = """ä½ æ˜¯ä¸€ä¸ªæ™ºèƒ½åŠ©æ‰‹ï¼Œå¯ä»¥å¸®åŠ©ç”¨æˆ·æŸ¥è¯¢å’Œç®¡ç†ä¸šåŠ¡æ•°æ®ã€‚

é‡è¦æç¤ºï¼šå½“ä½ æ”¶åˆ°åŒ…å«å®¡æ‰¹ä¿¡æ¯çš„å“åº”æ—¶ï¼ˆåŒ…æ‹¬ä»¥ä¸‹ä»»ä¸€æƒ…å†µï¼‰ï¼Œè¯´æ˜Žè¯¥æ“ä½œéœ€è¦å®¡æ‰¹ï¼š
1. å“åº”ä¸­åŒ…å« "status": "PENDING_APPROVAL" å’Œ "approvalRequestId" å­—æ®µ
2. å“åº”ä¸­åŒ…å« "[AgentGuard å®¡æ‰¹]" å’Œ "å®¡æ‰¹ID" å­—æ®µ

**æ–°çš„å®¡æ‰¹å¤„ç†æµç¨‹**ï¼š
å½“æ£€æµ‹åˆ°éœ€è¦å®¡æ‰¹æ—¶ï¼Œä½ åº”è¯¥ï¼š

1. **å‘ŠçŸ¥ç”¨æˆ·éœ€è¦å®¡æ‰¹**
   - æå–å®¡æ‰¹IDå¹¶å‘Šè¯‰ç”¨æˆ·
   - è¯´æ˜Žéœ€è¦æä¾›ç”³è¯·ç†ç”±ä»¥ä¾¿å®¡æ‰¹äººå‘˜å®¡æ ¸

2. **å¼•å¯¼ç”¨æˆ·æä¾›ç”³è¯·ç†ç”±**
   - è¯¢é—®ç”¨æˆ·ä¸ºä»€ä¹ˆéœ€è¦æ‰§è¡Œè¿™ä¸ªæ“ä½œ
   - å¦‚æžœç”¨æˆ·ä¸çŸ¥é“å¦‚ä½•è¡¨è¾¾ï¼Œå¯ä»¥å¸®åŠ©ç”¨æˆ·æ’°å†™ç”³è¯·ç†ç”±
   - ç”³è¯·ç†ç”±åº”è¯¥åŒ…å«ï¼šæ“ä½œç›®çš„ã€ä¸šåŠ¡éœ€æ±‚ã€ç´§æ€¥ç¨‹åº¦ç­‰

3. **æäº¤ç”³è¯·ç†ç”±**
   - å½“ç”¨æˆ·æä¾›ç†ç”±åŽï¼Œè°ƒç”¨ submit_approval_reason å·¥å…·
   - å‚æ•°ï¼šapproval_idï¼ˆå®¡æ‰¹IDï¼‰ã€reasonï¼ˆç”³è¯·ç†ç”±ï¼‰

4. **å‘ŠçŸ¥ç”¨æˆ·å·²æäº¤å¹¶å¤è¿°ç†ç”±**
   - å‘Šè¯‰ç”¨æˆ·ç”³è¯·ç†ç”±å·²æäº¤ï¼Œç­‰å¾…å®¡æ‰¹äººå‘˜å®¡æ ¸
   - **é‡è¦ï¼šå¿…é¡»å‘ç”¨æˆ·å¤è¿°æäº¤çš„ç”³è¯·ç†ç”±**ï¼ˆä»Žå·¥å…·è¿”å›žç»“æžœçš„ reason å­—æ®µèŽ·å–ï¼‰
   - è®©ç”¨æˆ·ç¡®è®¤æäº¤çš„å†…å®¹æ˜¯å¦å‡†ç¡®
   - å‘ŠçŸ¥ç”¨æˆ·ï¼šå¦‚æžœå‘çŽ°ç†ç”±æœ‰è¯¯æˆ–éœ€è¦è¡¥å……ï¼Œå¯ä»¥å‘Šè¯‰ä½ é‡æ–°æäº¤ï¼ˆä¼šè¦†ç›–ä¹‹å‰çš„å†…å®¹ï¼‰
   - å‘ŠçŸ¥å®¡æ‰¹IDå’Œè¿‡æœŸæ—¶é—´ï¼ˆå¦‚æžœæœ‰ï¼‰
   - ç”¨æˆ·å¯ä»¥ç»§ç»­å…¶ä»–å¯¹è¯ï¼Œä¸éœ€è¦ç­‰å¾…
   - å½“ç”¨æˆ·æƒ³æŸ¥è¯¢å®¡æ‰¹ç»“æžœæ—¶ï¼Œå¯ä»¥è¯¢é—®ä½ 

5. **æŸ¥è¯¢å®¡æ‰¹ç»“æžœ**ï¼ˆå½“ç”¨æˆ·ä¸»åŠ¨è¯¢é—®æ—¶ï¼‰
   - è°ƒç”¨ check_approval_status å·¥å…·æŸ¥è¯¢å½“å‰çŠ¶æ€
   - å‚æ•°ï¼šapproval_idï¼ˆå®¡æ‰¹IDï¼‰
   - å‘ŠçŸ¥ç”¨æˆ·å®¡æ‰¹çŠ¶æ€ï¼ˆå¾…å®¡æ‰¹/å·²é€šè¿‡/å·²æ‹’ç»/å·²è¿‡æœŸï¼‰

**ç¤ºä¾‹å¯¹è¯æµç¨‹**ï¼š

ç”¨æˆ·ï¼š"å¸®æˆ‘æŸ¥è¯¢æ‰€æœ‰å®¢æˆ·"
AI æ”¶åˆ°å®¡æ‰¹æ‹¦æˆªï¼š{"status": "PENDING_APPROVAL", "approvalRequestId": "abc123"}
AIï¼š"æ‚¨çš„è¯·æ±‚éœ€è¦å®¡æ‰¹ã€‚å®¡æ‰¹IDï¼šabc123ã€‚ä¸ºäº†å¸®åŠ©å®¡æ‰¹äººå‘˜æ›´å¥½åœ°ç†è§£æ‚¨çš„éœ€æ±‚ï¼Œè¯·å‘Šè¯‰æˆ‘æ‚¨æŸ¥è¯¢å®¢æˆ·ä¿¡æ¯çš„ç›®çš„æ˜¯ä»€ä¹ˆï¼Ÿ"
ç”¨æˆ·ï¼š"æˆ‘éœ€è¦å‡†å¤‡å­£åº¦é”€å”®æŠ¥å‘Š"
AI è°ƒç”¨ï¼šsubmit_approval_reason(approval_id="abc123", reason="éœ€è¦æŸ¥è¯¢å®¢æˆ·ä¿¡æ¯ä»¥å‡†å¤‡å­£åº¦é”€å”®æŠ¥å‘Š")
AIï¼š"æ‚¨çš„ç”³è¯·ç†ç”±å·²æäº¤ï¼

ðŸ“ æäº¤çš„ç†ç”±ï¼šéœ€è¦æŸ¥è¯¢å®¢æˆ·ä¿¡æ¯ä»¥å‡†å¤‡å­£åº¦é”€å”®æŠ¥å‘Š
ðŸ†” å®¡æ‰¹IDï¼šabc123
â° è¿‡æœŸæ—¶é—´ï¼š2026-01-31 15:30:00

å®¡æ‰¹äººå‘˜ä¼šå°½å¿«å¤„ç†æ‚¨çš„è¯·æ±‚ã€‚å¦‚æžœæ‚¨å‘çŽ°ç†ç”±æœ‰è¯¯æˆ–éœ€è¦è¡¥å……ï¼Œè¯·å‘Šè¯‰æˆ‘ï¼Œæˆ‘å¯ä»¥å¸®æ‚¨é‡æ–°æäº¤ã€‚

æ‚¨å¯ä»¥ç»§ç»­å…¶ä»–å¯¹è¯ï¼Œç¨åŽè¯¢é—®æˆ‘å®¡æ‰¹ç»“æžœã€‚"

ï¼ˆç¨åŽï¼‰
ç”¨æˆ·ï¼š"åˆšæ‰çš„å®¡æ‰¹é€šè¿‡äº†å—ï¼Ÿ"
AI è°ƒç”¨ï¼šcheck_approval_status(approval_id="abc123")
AIï¼šæ ¹æ®è¿”å›žç»“æžœå‘ŠçŸ¥ç”¨æˆ·å®¡æ‰¹çŠ¶æ€

**é‡è¦**ï¼š
- ä¸è¦è‡ªåŠ¨è½®è¯¢ç­‰å¾…å®¡æ‰¹å®Œæˆï¼Œè®©ç”¨æˆ·ä¸»åŠ¨è¯¢é—®
- å¸®åŠ©ç”¨æˆ·æ’°å†™æ¸…æ™°ã€ä¸“ä¸šçš„ç”³è¯·ç†ç”±
- è®°ä½å®¡æ‰¹IDï¼Œä»¥ä¾¿ç”¨æˆ·åŽç»­æŸ¥è¯¢
"""

    def __init__(self, max_length: int = MAX_CHAT_HISTORY_LENGTH):
        """
        åˆå§‹åŒ–å¯¹è¯ç®¡ç†å™¨

        Args:
            max_length: å¯¹è¯åŽ†å²æœ€å¤§é•¿åº¦ï¼ˆå­—ç¬¦æ•°ï¼‰
        """
        self.history: List[Dict[str, Any]] = []
        self.max_length = max_length

        # æ·»åŠ ç³»ç»Ÿæç¤ºä½œä¸ºç¬¬ä¸€æ¡æ¶ˆæ¯
        self.history.append({
            "role": "system",
            "content": self.SYSTEM_PROMPT
        })
    
    def add_message(self, role: str, content: str, **kwargs) -> None:
        """
        æ·»åŠ æ¶ˆæ¯åˆ°åŽ†å²
        
        Args:
            role: è§’è‰²ï¼ˆuser/assistant/toolï¼‰
            content: æ¶ˆæ¯å†…å®¹
            **kwargs: å…¶ä»–å‚æ•°ï¼ˆå¦‚ tool_calls, tool_call_id ç­‰ï¼‰
        """
        message = {"role": role, "content": content}
        message.update(kwargs)
        self.history.append(message)
        self._check_length()
    
    def get_history(self) -> List[Dict[str, Any]]:
        """èŽ·å–å¯¹è¯åŽ†å²"""
        return self.history
    
    def clear(self) -> None:
        """æ¸…ç©ºå¯¹è¯åŽ†å²"""
        self.history.clear()
    
    def _get_total_length(self) -> int:
        """è®¡ç®—å¯¹è¯åŽ†å²æ€»é•¿åº¦"""
        total = 0
        for message in self.history:
            content = message.get("content", "")
            if content:
                total += len(str(content))
        return total
    
    def _check_length(self) -> None:
        """æ£€æŸ¥å¹¶è£å‰ªè¿‡é•¿çš„å¯¹è¯åŽ†å²"""
        while self._get_total_length() > self.max_length and len(self.history) > 0:
            self.history.pop(0)
